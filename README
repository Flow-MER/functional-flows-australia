# =============================================================================== 
#  ______                _   _                   _  
# |  ___|              | | (_)                 | | 
# | |_ _   _ _ __   ___| |_ _  ___  _ __   __ _| | 
# |  _| | | | '_ \ / __| __| |/ _ \| '_ \ / _` | | 
# | | | |_| | | | | (__| |_| | (_) | | | | (_| | | 
# \_|  \__,_|_| |_|\___|\__|_|\___/|_| |_|\__,_|_| 
#                                                                                             
# ______ _                                         
# |  ___| |                                        
# | |_  | | _____      _____                       
# |  _| | |/ _ \ \ /\ / / __|                      
# | |   | | (_) \ V  V /\__ \                      
# \_|   |_|\___/ \_/\_/ |___/                      
#                                                                                              
#   ___                                            
#  / _ \                                           
# / /_\ \_   _ ___                                 
# |  _  | | | / __|                                
# | | | | |_| \__ \                                
# \_| |_/\__,_|___/                                                                          
#                                               
# Author: Luke Lloyd-Jones, Email - luke.lloyd-jones@csiro.au
# ===============================================================================

This package contains an R package (and hydrometric output 'locally not on git') 
that compute hydrometrics from hydrological data generated by in-stream flow 
gauges. The code and concepts are based on the Function Flows approach, which is 
described here and in other relevant references cited in this work.


Primary citation
----------------
Yarnell, Sarah M., et al. "A functional flows approach to selecting ecologically 
relevant flow metrics for environmental flow applications." River Research and 
Applications 36.2 (2020): 318-324.

The code in the ffaus R package is a heavily adapted translation of the Python 
libraries available from here https://github.com/leogoesger/func-flow.

The Python libraries were adapted for the Australian context but 
in parts still resemble the ideas implemented in the original code.

The package was used to generate functional flow hydrometrics using the 
R script 'flowmer_ff_all_gauges.R' and R version 4.0.4. The R package 'ffaus' is 
installed at this stage using devtools::install("ffaus"), which requires devtools
to be installed. It has been tested on my personal mac system and run on the Linux 
HPC node with 'plot_out_base' on lines 171 and 211 set to NULL so plots are not 
produced. The code at this stage is best run for full diagnostic plots using 
RStudio.

The 'flowmer_ff_all_gauges.R' R script uses the functions in ffaus to generate
hydrometrics for 100 gauges that span the Murray-Darling basin in Australia. 
These 100 gauges were deemed relevant and reliable by the hydrological Flow-MER 
theme. The code and output in this folder is designed to be fully reproducible 
via just running the 'flowmer_ff_all_gauges.R' script provided you have the flow 
data, which is not provided on the git repo for privacy reasons. The 
'flowmer_ff_all_gauges.R' is presented as an example script for using the 
in development R package. 

The output for each gauge site has been quality controlled via an initial run 
of the ffaus code using default parameters and then an updated run if diagnostic
plots show aberrations due to default parameters not representing the variation 
in the hydrograph of that site's hydrographs. 

The contents are:

/data (** Not on git repo **)
  FlowMER_Streamflow_2014-20.csv
    - The hydrological data from the Murray- Darlin Basin (MDB) used as input 
      into the hydrometric computation. I have
      left this here as it is reasonably lightweight and a user can just pick it
      up the code and have a go with these data. 
    - The flow values are in ML/day and has flow values for total flow (FLOW) and
      the portion contributed from Commonwealth Environemental Water Office (CEW)
      for each site. 
    - These are the raw data that are taken in and summarised by the process.

functional_flows_aus.pdf
  - A document that gives a brief introduction to the functional flow methodology
    and then a very detailed summary of the principal components of each functions
    metric calculation. 
  - Also contains troublshooting options and reasons for why you may see NAs in 
    the output. 
  - You can also query each function in R as to its input and output for further
    details.

/func_flow_r_aus.Rproj
  R project file, which should help with setting up the environment and allow
  for a quick try of the code.

flowmer_ff_all_gauges.R
  - R programming script that has the calls functions from the ffaus R package.
    The script reads the stream flow data in /data.

    The script iterates over the 100 gauges and takes default or 'special' 
    parameters inpute to the ffaus master function 'getFFMetrics' and produces 
    functional flows hydrometrics and exceedance metrics for both the observed 
    flow and the counterfactual, which incorporated the contribution from the 
    Commonwealth Environmental Water Office (CEWO). The results are written to 
    /flowmer_all_gauges_ffaus_out for each 'valley' and 'site' of interest.

/flowmer_all_gauges_ffaus_out
  For each valley the sites within that valley have subfolders that contain 
  output in the form of diagnostic plots for key parts if the ffaus estimation 
  process and the hydrometrics for the observed and counterfactual flows.

  /*valley*/*site*/
    - *.png includes diagnostic plots for each of the initiation flows,
      wet season, recession flows, and dry season. The vertical lines usually
      correspond to important markers e.g., date of dry season start and horizontal
      lines are usually thresholds. The smooth-coloured linear are different layers
      of smoothing used through the overly complex code.

    - valley*_*site*_observed_metrics.csv 
      The exceedance and functional flow hydrometrics for the observed flows. 
      Please ask me if you have any questions.

    - valley*_*site*_counterfactual_metrics.csv
      Ditto above except for counterfactual flows.

    - valley*_*site*_global_hydrograph.png
      IMO a nice summary of the GLOBAL hydrograph that includes the counterfactual 
      and observed flows along with visual summary of the seasons.



